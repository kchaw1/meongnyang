<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nmcat.repository.mapper.CrowdMapper">
	<resultMap id="crowdMap" type="Crowd">
		<result column="cr_no" property="crNo" />
		<result column="cr_writer" property="crWriter" />
		<result column="cr_title" property="crTitle" />
		<result column="cr_content" property="crContent" />
		<result column="cr_now_money" property="crNowMoney" />
		<result column="cr_goal_money" property="crGoalMoney" />
		<result column="cr_start_day" property="crStartDay" />		
		<result column="cr_end_day" property="crEndDay" />
		<result column="cr_like_cnt" property="crLikeCnt" />
		<result column="cr_reg_date" property="crRegDate" />
		<result column="cr_view_cnt" property="crViewCnt" />
		<result column="cr_file_name" property="crFileName" />
		<result column="cr_file_path" property="crFilePath" />
		<result column="cr_file_ori_name" property="crFileOriName" />
		<result column="cr_end_yn" property="crEndYN" />
	</resultMap>
	
	<resultMap id="memberMap" type="Member">
		<result column="no" property="no" />
		<result column="id" property="id" />
		<result column="type" property="type" />
		<result column="pass" property="pass" />
		<result column="category" property="category" />
		<result column="email" property="email" />
		<result column="abs_like_count" property="absLikeCount" />
		<result column="grade_no" property="gradeNo" />
		<result column="image_name" property="imageName" />
		<result column="image_path" property="imagePath" />
		<result column="image_size" property="imageSize" />
		<result column="sign_up_date" property="signUpDate" />
		<result column="login_state" property="loginState" />
		<result column="auth_state" property="authState" />
		<result column="greetings" property="greetings" />
		<result column="point" property="point" />
		<result column="login_date_time" property="loginDateTime" />
	</resultMap>
	
	<resultMap id="crowdLikeMap" type="CrowdLike">
		<result column="cr_no" property="crNo" />
		<result column="cr_id" property="crId" />
	</resultMap>

<!-- 크라우드펀딩 등록 -->
<insert id="insertCrowd" parameterType="Crowd">
	insert into mn_crowd(cr_writer, cr_title, cr_content, cr_goal_money, cr_start_day, cr_end_day, cr_file_name, cr_file_path, cr_file_ori_name) 
	     values(#{crWriter}, #{crTitle}, #{crContent}, #{crGoalMoney}, #{crStartDay}, #{crEndDay}, #{crFileName}, #{crFilePath}, #{crFileOriName})
</insert>

<!-- 크라우드펀딩 리스트 -->
<select id="selectCrowdList" parameterType="Crowd" resultMap="crowdMap">
	select *
	  from mn_crowd 
	 where cr_end_yn = 'n'
	 order by cr_end_day asc
	 limit #{begin}, 8 
</select>

<!-- 크라우드 펀딩 디테일 -->
<select id="selectCrowdDetail" parameterType="int" resultMap="crowdMap">
	select * 
	  from mn_crowd
	 where cr_no = #{crNo}
</select>

<!-- 좋아요 업데이트 -->

<!-- 추천 개수 -->
<select id="selectLikeCount" parameterType="int" resultType="int">
	select cr_like_cnt
	  from mn_crowd
	 where cr_no = #{crNo}  
</select>

<!-- 추천하기 -->	
<insert id="insertLike" parameterType="CrowdLike">
	INSERT INTO mn_crowd_like(cr_no, cr_id) VALUES (#{crNo}, #{crId})
</insert>
<update id="updateLikeCntUp" parameterType="int">
	update mn_crowd
	   set cr_like_cnt = cr_like_cnt + 1
	 where cr_no = #{crNo}    
</update>

<!-- 취소하기 -->
<delete id="deleteLike" parameterType="CrowdLike">
	delete from mn_crowd_like
	 where cr_id = #{crId} AND cr_no = #{crNo}
</delete>
<update id="updateLikeCntDown" parameterType="int">
	update mn_crowd
	   set cr_like_cnt = cr_like_cnt - 1
	 where cr_no = #{crNo}    
</update>

<!-- 추천 여부 확인 -->
<select id="selectLikeCheck" resultType="int" parameterType="CrowdLike">
	select count(*)
	  from mn_crowd_like
	 where cr_id = #{crId} AND cr_no = #{crNo}
</select>

<!-- 기부하기 -->
<update id="updateNowMoney" parameterType="Crowd">
	update mn_crowd
	   set cr_now_money = cr_now_money + #{donateMoney} 
	 where cr_no = #{crNo}  
</update>

<!-- 포인트차감 -->
<update id="updateMemberPoint" parameterType="Member">
	update mn_member
	   set point = point - #{donateMoney}
	 where no = #{no}  
</update>

<!-- 보유포인트 -->
<select id="selectNowPoint" parameterType="int" resultType="int">
	select point
	  from mn_member
	 where no = #{no} 
</select>

</mapper>